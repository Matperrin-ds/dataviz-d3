<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <style>
    body { margin:0;position:fixed;top:0;right:0;bottom:0;left:0; }
  </style>
</head>

<body>
  
  <div id="heatmap"> </div>
  
  <script>

    let months = ["Janvier", 
                  "Février", 
                  "Mars", 
                  "Avril", 
                  "Mai",
                  "Juin",
                  "Juillet",
                  "Aout",
                  "Septembre",
                  "Octobre",
                  "Novembre",
                  "Décembre"]

    days = d3.range(31),
      
    margin = {
        top: 90,
        right: 50,
        bottom: 140,
        left: 50
    };
    
    width = Math.max(Math.min(window.innerWidth, 1000), 500) - margin.left - margin.right;
    gridSize = Math.floor(width / days.length);
    height = gridSize * months.length;

    
    var maingroup = d3.select('#heatmap')
    .append("svg")
    .attr("class", "svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    
    
    var monthLabels = maingroup.selectAll(".monthLabel")
    .data(months)
    .enter().append("text")
        .text(function (d) { return d; })
        .attr("x", 0)
        .attr("y", function (d, i) { return i * gridSize; })
        .attr("transform", "translate(-6," + gridSize / 2 + ")")
        .attr("class", function (d, i) { return ((i >= 0 && i <= 4) ? "monthLabel axis-days" : "monthLabel"); })
        .style("text-anchor", "end");

    var timeLabels = maingroup.selectAll(".timeLabel")
        .data(days)
        .enter().append("text")
            .text(function(d) { return d; })
            .attr("x", function(d, i) { return i * gridSize; })
            .attr("y", 0)
            .attr("transform", "translate(" + gridSize / 2 + ", -6)")
            .attr("class", function(d, i) { return ((i >= 9 && i <= 19) ? "timeLabel axis-worktime" : "timeLabel"); })
            .style("text-anchor", "middle");
    
    
    maingroup.append("text")
    .attr("class", "title")
    .attr("x", width / 2)
    .attr("y", -70)
    .style("text-anchor", "middle")
    .text("Consommation électrique");

    maingroup.append("text")
        .attr("class", "credit")
        .attr("x", width/2)
        .attr("y", gridSize * (months.length+1) + 80)
        .style("text-anchor", "middle")
        .text("Basé sur le travail de Nadieh Bremer & Miles McCrocklin");
    
    
    d3.csv("conso_by_day_2014.csv", (data) => {
      data.forEach(function(d) {
        d.cons = +d.Consommation;
        d.day = +d.Jour;
        d.month = +d.Mois;
      });
      
      
      console.log(data)

      maingroup.append("text")
        .attr("class", "subtitle")
        .attr("x", width / 2)
        .attr("y", -40)
        .style("text-anchor", "middle")
        .text("Consommation totale en 2014 - " + d3.sum(data, function(d) {return d.cons; }) + " (unité à vérifier)");

      var colorScale = d3.scaleLinear()
      .domain([0, d3.max(data, function(d) {return d.cons; }) / 2, d3.max(data, function(d) {return d.cons; })])
      .range(["#fdf6c8", "#fdcfaa", "#bc2f19"]);
  
  
  var heatMap = maingroup.selectAll(".day")
    .data(data)
    .enter().append("rect")
        .attr("x", function(d) { return d.day * gridSize; })
        .attr("y", function(d) { return d.month * gridSize; })
        .attr("width", gridSize)
        .attr("height", gridSize)
        .style("stroke", "white")
        .style("stroke-opacity", 0.6)
        .style("fill", function(d) { return colorScale(d.cons); });
      
      
     var consoScale = d3.scaleLinear()
    		.domain([0, d3.max(data, function(d) {return d.cons; })])
    		.range([0, width])

    numStops = 3;
    consoPoint = [0, d3.max(data, function(d) {return d.cons; }) / 2, d3.max(data, function(d) {return d.cons; })];

    maingroup.append("defs")
        .append("linearGradient")
        .attr("id", "legend-traffic")
        .attr("x1", "0%").attr("y1", "0%")
        .attr("x2", "100%").attr("y2", "0%")
        .selectAll("stop") 
        .data(d3.range(numStops))                
        .enter().append("stop") 
            .attr("offset", function(d,i) { 
                return consoScale(consoPoint[i]) / width;
            })   
            .attr("stop-color", function(d,i) { 
                return colorScale(consoPoint[i]); 
            });

    var legendWidth = Math.min(width * 0.8, 400);

    var legendsvg = maingroup.append("g") // groupe principal
        .attr("class", "legendWrapper")
        .attr("transform", "translate(" + (width/2) + "," + (gridSize * months.length + 40) + ")");

    legendsvg.append("rect") // rectangle avec gradient
        .attr("class", "legendRect")
        .attr("x", -legendWidth/2)
        .attr("y", 0)
        .attr("width", legendWidth)
        .attr("height", 10)
        .style("fill", "url(#legend-traffic)");
        
    legendsvg.append("text") // légende
        .attr("class", "legendTitle")
        .attr("x", 0)
        .attr("y", -10)
        .style("text-anchor", "middle")
        .text("Consommation quotidienne");

    var xScale = d3.scaleLinear() // scale pour x-axis
         .range([-legendWidth / 2, legendWidth / 2])
         .domain([ 0, d3.max(data, function(d) { return d.cons; })] );

    legendsvg.append("g") // x axis
        .attr("class", "axis")
        .attr("transform", "translate(0," + (10) + ")")
        .call(d3.axisBottom(xScale).ticks(5));

});
    
    
    
    

    
    
  </script>
</body>
