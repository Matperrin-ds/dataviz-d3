<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="France Electricity Consumption Visualisation">
  <meta name="author" content="Lancelot Prégniard">

  <title>Consumption curves in France</title>

  <!-- Bootstrap core CSS -->
  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom styles for this template -->
  <link href="css/business-frontpage.css" rel="stylesheet">

  <!-- D3 -->
  <script src="https://d3js.org/d3.v4.min.js"></script>

</head>

<body>

  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container">
      <a class="navbar-brand" href="#">Electricity in France</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="index.html">Home</a>
          </li>
          <li class="nav-item active">
            <a class="nav-link" href="visu1.html">Consumption curves
            <span class="sr-only">(current)</span>
          </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="visu2.html">Consumption Heatmap</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="visu3.html">Energy mix</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

 
 <!-- First row -->

  <div class="container">
 
    <div class="col-md-15 mb-5">
        <br>
        <br>
         <h2>Daily energy consuption curves in France</h2>
         <hr>
        <p>todo: Expliquer les différentes visualisation.</p>
        <p>todo: Et le but de l'étude.</p>
        <br>
        <br>
    </div>

     <div class="col-md-15 mb-5">

       <script>


var margin = {top: 20, right: 100, bottom: 50, left: 60},
    //width = 960 - margin.left - margin.right,
    width = 900 - margin.left - margin.right,
    height = 300 - margin.top - margin.bottom;

var y = d3.scaleLinear()
    .rangeRound([height, 0])
		.nice();

var x = d3.scaleBand()
    .rangeRound([0, width])
    .paddingInner(0.1)
    .align(0.1)
    
var z = d3.scaleOrdinal(d3.schemeCategory20)

  // Date format https://bl.ocks.org/zanarmstrong/ca0adb7e426c12c06a95
  var parseTime  = d3.timeParse("%d/%m/%Y")
  
  //var formatTime = d3.timeFormat("%d-%m")
    var formatTime = d3.timeFormat("%d")
    
  link2 = 'https://raw.githubusercontent.com/Matperrin-ds/Dataviz/master/data_RTE2.csv'
  
  d3.csv(link2, function(error, raw) {
    
    var symbols = [];
    var data = []
    
    // Data pre-processing
    raw.forEach(function(d, i) {
      
      if(symbols.indexOf(d.symbol) < 0) {
        symbols.push(d.symbol)
        data[symbols.indexOf(d.symbol)] = [];
      }
      
      // String to INT
      d.value = +d.consumption;     
 
      // Parsing time
      d.date = parseTime(d.date)
      data[symbols.indexOf(d.symbol)].push(d);
    });
    
    var data_nest = d3.nest()
    	.key(function(d) { return formatTime(d.date); })

    	.key(function(d) { return d.symbol; })
    	.rollup(function(v) { return d3.sum(v, function(d) { return d.consumption; }); })
			.entries(raw);
    
    var years = data_nest.map(function(d) { return d.key; })
    
    var data_stack = []
    
    symbols_no_tot = symbols.slice(0,-1)
    
    data_nest.forEach(function(d, i) {
      d.values = d.values.map(function(e) { return e.value; })
      var t ={}
      symbols_no_tot.forEach(function(e, i) {
        t[e] = d.values[i]
      })
      t.year = d.key;
      data_stack.push(t)
    })
    
    console.log(data_stack)
    
    var layers = d3.stack().keys(symbols_no_tot)(data_stack);

    var max = d3.max(layers[layers.length-1], function(d) { return d[1]; });
    
    y.domain([0, max]);
    x.domain(years);
    
    console.log(data_stack)
    
    var svg = d3.select("body").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    svg.append("g").selectAll("g")
          .data(layers)
      .enter().append("g")
        .style("fill", function(d) { return z(d.key); })	
        .selectAll("rect")
      .data(function(d) {  return d; })
        .enter().append("rect")
          .attr("x", function(d, i) { return x(d.data.year); })
          .attr("y", function(d) { return y(d[1]); })
          .attr("height", function(d) { return y(d[0]) - y(d[1]); })
          .attr("width", x.bandwidth())
    			.on("mouseover", function(d,i){ 
    			d3.selectAll("rect")
          .style("opacity", 1)
          d3.select(this).style("opacity",.7)
    			})
    			.on("mouseover", mouseover)
    			.on("mouseout", function(d) {d3.selectAll("rect")
          .style("opacity", 1)})
    
    svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x))
    
    svg.append("g")
      .attr("class", "y axis")
      .attr("transform", "translate(" + (0) + ", 0)")
      .call(d3.axisLeft().scale(y))
    
    var colors = ["b33040", "#d25c4d", "#f2b447", "#d9d574"]
    
    var legend = svg.selectAll(".legend")
  	.data(layers)
  	.enter().append("g")
  	.attr("class", "legend")
    .attr('transform', (d,i) => `translate(${-750 +i * 105},${height + 30})`);
  	//.attr("transform", function(d, i) { return "translate(-30," + i * 19 + ")"; })
    //.attr("transform", function(d, i) { return "translate("+(-1)*i + i * 19 + ", 250)"; })
    
    legend.append("rect")
  	.attr("x", width - 18)
  	.attr("width", 18)
  	.attr("height", 18)
  	.style("fill", function(d, i) {return z(d.key)});
    
    legend.append("text")
      .attr("x", width + 5)
      .attr("y", 9)
      .attr("dy", ".35em")
      .style("text-anchor", "start")
      .text(function(d, i) { return symbols[i]
  });
    
    })
  
  var tooltip = d3.select("body").append("div")
  .attr("class", "hidden tooltip")
  function mouseover(d) {
     console.log(d)
     let sum = 0;
     let cat = ""
     let value = 0
     let total = d.data.Total
     Object.keys(d.data).forEach((key) => {
       if (key != 'Date' && key != 'Total'){
        sum += d.data[key]
        if (sum == d[1]){
          cat = key
          value = d.data[key]
        }
       }
      
     });
      var s = d3.select(this);
      s
          .transition()
          .duration(1)
          .style("opacity", 0.5)
      tooltip
          .classed("hidden", false)
          .html(cat +" : " + value + "<br>" +
          Math.round(value/total*100) + "% du total produit")
}
  
  
</script>

     </div>


    </div>

    <!-- Footer -->
  <footer class="py-5 bg-dark">
    <div class="container">
      <p class="m-0 text-center text-white">coded @centralelyon &copy; 2020</p>
    </div>
    <!-- /.container -->
  </footer>
  


</body>
